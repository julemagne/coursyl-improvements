<style>
    g.node {
        font-family: Verdana, Helvetica;
        font-size: 12px;
        font-weight: bold;
    }
    circle.node-dot {
        fill: lightsalmon;
        stroke: red;
        stroke-width: 1px;
    }

    path.link {
        fill: none;
        stroke: gray;
    }
</style>

<script>

var treeData = <%= @course.lesson_tree.to_json.html_safe %>;

function visit(parent, visitFn, childrenFn)
{
    if (!parent) return;

    visitFn(parent);

    var children = childrenFn(parent);
    if (children) {
        var count = children.length;
        for (var i = 0; i < count; i++) {
            visit(children[i], visitFn, childrenFn);
        }
    }
}

function buildTree(containerName, customOptions)
{
    // build the options object
    var options = $.extend({
        nodeRadius: 5, sidePadding: 30
    }, customOptions);

    // size of the diagram
    var size = { width:$(containerName).outerWidth(), height:150};

    var tree = d3.layout.tree()
        .sort(null)
        .size([size.height, size.width - options.sidePadding*2])
        .children(function(d)
        {
            return (!d.contents || d.contents.length === 0) ? null : d.contents;
        });

    var nodes = tree.nodes(treeData);
    var links = tree.links(nodes);

    var layoutRoot = d3.select(containerName)
        .append("svg:svg").attr("width", size.width).attr("height", size.height)
        .append("svg:g")
        .attr("class", "container")
        .attr("transform", "translate(" + options.sidePadding + ",0)");

    var link = d3.svg.diagonal()
        .projection(function(d)
        {
            return [d.y, d.x];
        });

    layoutRoot.selectAll("path.link")
        .data(links)
        .enter()
        .append("svg:path")
        .attr("class", "link")
        .attr("d", link);

    var nodeGroup = layoutRoot.selectAll("g.node")
        .data(nodes)
        .enter()
        .append("svg:g")
        .attr("class", "node")
        .attr("node-name", function(d){d.name;})
        .attr("transform", function(d)
        {
            return "translate(" + d.y + "," + d.x + ")";
        });

    nodeGroup.append("svg:circle")
        .attr("class", "node-dot")
        .attr("r", options.nodeRadius);

    nodeGroup.append("svg:text")
        .attr("text-anchor", function(d)
        {
            return d.children ? "end" : "start";
        })
        .attr("dx", function(d)
        {
            var gap = 2 * options.nodeRadius;
            return d.children ? -gap : gap;
        })
        .attr("dy", 3)
        .text(function(d)
        {
            return ""; //Node label goes here
        });

}

$(function(){
   buildTree("#tree-container");
});

</script>

<div id="tree-container"></div>
